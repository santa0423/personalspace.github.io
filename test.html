<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Likert 20 Questions</title>
  <link rel="stylesheet" href="test.css"/>
</head>
<body>
  <!-- 상단 헤더: sticky -->
  <header class="top-header">
    <div class="header">
      <button class="back">＜ 이전&nbsp;</button>
      <span class="step" id="stepText">(0/20)</span>
    </div>
    <div class="meter">
      <div class="bar" id="progressBar" style="width:0%"></div>
    </div>
  </header>

  <!-- 본문: 3개씩 보이는 영역 (스크롤은 body가 담당) -->
  <main class="content container">
    <div id="questionList"></div>
  </main>

  <!-- 하단 결과 버튼 -->
  <div class="result-wrap">
    <button id="resultBtn" disabled>결과보기</button>
  </div>

  <!-- 결과 계산 로딩 오버레이 -->
  <div class="loading-layer" id="loadingLayer" aria-hidden="true">
    <div class="loading-card">
      <h1 class="loading-title">당신의 퍼스널 스페이스는?</h1>
      <img src="images/cactus.png" alt="로딩 캐릭터" class="loading-img" />
      <div class="loading-bar">
        <div class="loading-fill"></div>
      </div>
      <p class="loading-sub">결과 나오는 중…</p>
    </div>
  </div>

  <script>
    // 문항 + 양끝 라벨 정의
    const QUESTIONS = [
      { text: "1. 늦은 밤 혹은 휴일에 업무 메신저 알림이 울리면 불쾌하다.", left: "그렇지 않다", right: "그렇다" },
      { text: "2. SNS에서 상대방이 동의 없이 나를 태그하거나, 내가 포함된 사진을 게시하면 불쾌하다.", left: "그렇지 않다", right: "그렇다" },
      { text: "3. SNS에서 내가 지정한 사람만 볼 수 있는 기능으로 게시물을 주로 게시한다.", left: "그렇지 않다", right: "그렇다" },
      { text: "4. 상대방이 지나치게 자주 메시지를 보내거나 답장을 독촉하면 내 시간을 존중하지 않는다고 느껴진다.", left: "그렇지 않다", right: "그렇다" },
      { text: "5. 친분과 상관없이 악수나 어깨 두드리기 등 신체 접촉을 최대한 하지 않는 편이다.", left: "그렇지 않다", right: "그렇다" },
      { text: "6. 쉬는 날 활기찬 놀이공원·백화점 대신 조용한 공원·카페에 가는 편이다.", left: "그렇지 않다", right: "그렇다" },
      { text: "7. 조용한 카페 등에서 누군가 가까이 앉으면 평소처럼 행동하기 어려워진다.", left: "그렇지 않다", right: "그렇다" },
      { text: "8. 엘리베이터 계기판 위치 → 왼쪽(구석) vs 오른쪽(중앙)", left: "편안하다", right: "많이 불편하다" },
      { text: "9. 친분과 상관없이 타인이 나에게 개인적인 질문을 하면 답하기 꺼려진다.", left: "그렇지 않다", right: "그렇다" },
      { text: "10. 같은 말이라도 상대의 어투에 따라 기분이 달라진다.", left: "그렇지 않다", right: "그렇다" },
      { text: "11. ”네가 그렇게 하면 내가 얼마나 상처받는 줄 알아?”처럼 감정을 강요하면 부담된다.", left: "그렇지 않다", right: "그렇다" },
      { text: "12. 갑자기 너무 빠르게 말하거나 침묵이 길어지면 심리적 압박이 느껴진다.", left: "그렇지 않다", right: "그렇다" },
      { text: "13. 직장에서 사람들과 함께 일하고 난 뒤, 친한 친구와 약속을 잡기보단 혼자 쉬고싶다.", left: "그렇지 않다", right: "그렇다" },
      { text: "14. 사람이 많다고 느끼거나 불편한 말을 들으면 심장이 두근거린다", left: "그렇지 않다", right: "그렇다" },
      { text: "15. 사람이 많은 장소에 가면 평소와 다르게 짜증이나 화가 자주 난다.", left: "그렇지 않다", right: "그렇다" },
      { text: "16. 누군가랑 부딪히거나 불편한 대화를 나누었을때 그날은 괜히 의욕이 없고 무기력해진다.", left: "그렇지 않다", right: "그렇다" },
      { text: "17. 여러 명이 함께 있는 독서실보다 집에서 혼자 할 일을 할 때 더 수월하게 진행된다.", left: "그렇지 않다", right: "그렇다" },
      { text: "18. 너무 피곤한 날에는 만원 버스에서 노약자에게 자리를 양보하지 않는다.", left: "그렇지 않다", right: "그렇다" },
      { text: "19. 아무리 불편함을 표현해도 바뀌지 않으면, ‘그냥 참는 게 낫겠다'고 생각한다.", left: "그렇지 않다", right: "그렇다" },
      { text: "20. 다른 사람과 너무 가까이 있어야 하는 상황에서 호흡이 어렵고 몸을 긴장하게 된다.", left: "그렇지 않다", right: "그렇다" }
    ];

    const list      = document.getElementById('questionList');
    const bar       = document.getElementById('progressBar');
    const stepText  = document.getElementById('stepText');
    const resultBtn = document.getElementById('resultBtn');
    const loadingLayer = document.getElementById('loadingLayer');

    // 문항 DOM 생성 (8번은 이미지 포함)
    QUESTIONS.forEach((q, idx) => {
      const qEl = document.createElement('section');
      qEl.className = 'q';

      const imgTag = (idx === 7)
        ? `<img src="images/elevator.png" alt="엘리베이터 그림" class="q-img">`
        : "";

      qEl.innerHTML = `
        <h2 class="q-title">${imgTag} ${q.text}</h2>
        <div class="likert">
          <span class="label-left">${q.left || '그렇지 않다'}</span>
          <div class="track">
            ${[1,2,3,4,5].map(v => `
              <label class="dot">
                <input type="radio" name="q${idx+1}" value="${v}">
                <span></span>
              </label>
            `).join('')}
          </div>
          <span class="label-right">${q.right || '그렇다'}</span>
        </div>
      `;
      list.appendChild(qEl);
    });

    const sections = [...document.querySelectorAll('.q')];

    // 초기: 1번만 활성, 나머지 비활성
    sections.forEach((sec, i) => {
      if (i > 0) setDisabled(sec, true);
      sec.addEventListener('change', (e) => {
        if (e.target.matches('input[type="radio"]')) {
          const next = sections[i+1];
          if (next && next.classList.contains('disabled')) {
            setDisabled(next, false);
            next.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          updateProgress();
        }
      });
    });

    function setDisabled(sectionEl, disabled) {
      sectionEl.classList.toggle('disabled', disabled);
      sectionEl.querySelectorAll('input[type="radio"]').forEach(inp => inp.disabled = disabled);
    }

    function updateProgress() {
      const answered = sections.reduce((acc, sec) =>
        acc + (sec.querySelector('input[type="radio"]:checked') ? 1 : 0), 0);
      const pct = Math.round(answered / sections.length * 100);
      bar.style.width      = pct + '%';
      stepText.textContent = `(${answered}/${sections.length})`;
      resultBtn.disabled   = answered !== sections.length;
    }

    // 카테고리 매핑
    const MAP = {
      physical:       [5,6,7,8,14,15,20],
      psychological:  [10,11,12,16,17,19],
      online:         [1,2,3,4,9,13,18]
    };

    function collectAnswers(){
      const answers = [];
      for(let i=1; i<=20; i++){
        const checked = document.querySelector(`input[name="q${i}"]:checked`);
        answers.push( checked ? Number(checked.value) : null );
      }
      return answers;
    }

    function calcScores(answers){
      const sum = (arr)=>arr.reduce((a,b)=>a+(b??0),0);
      const pick = (idxArr)=>idxArr.map(n=>answers[n-1]??0);

      const physicalVals   = pick(MAP.physical);
      const psychVals      = pick(MAP.psychological);
      const onlineVals     = pick(MAP.online);

      const maxPhysical    = MAP.physical.length    * 5;
      const maxPsych       = MAP.psychological.length*5;
      const maxOnline      = MAP.online.length      * 5;

      const sPhysical = sum(physicalVals);
      const sPsych    = sum(psychVals);
      const sOnline   = sum(onlineVals);

      const pctPhysical = Math.round(sPhysical / maxPhysical * 100);
      const pctPsych    = Math.round(sPsych / maxPsych * 100);
      const pctOnline   = Math.round(sOnline / maxOnline * 100);

      const rank = [
        {key:'physical', label:'물리 민감형', score:pctPhysical},
        {key:'psychological', label:'심리 민감형', score:pctPsych},
        {key:'online', label:'온라인 민감형', score:pctOnline},
      ].sort((a,b)=>b.score-a.score);

      const balanced = Math.abs(rank[0].score - rank[2].score) <= 8;
      const top = rank[0];

      return {
        raw: answers,
        sum: {physical:sPhysical, psychological:sPsych, online:sOnline},
        pct: {physical:pctPhysical, psychological:pctPsych, online:pctOnline},
        max: {physical:maxPhysical, psychological:maxPsych, online:maxOnline},
        type: balanced ? {key:'balanced', label:'균형형', score:rank[0].score} : top,
        rank
      };
    }

    // 결과보기 클릭: 로딩 → 결과 계산 → 저장 → 이동
    resultBtn.addEventListener('click', () => {
      if (resultBtn.disabled) return;
      const answers = collectAnswers();

      loadingLayer.style.display = 'flex';
      setTimeout(()=>{
        const result = calcScores(answers);
        sessionStorage.setItem('ps-result', JSON.stringify(result));
        location.href = 'result.html';
      }, 1400);
    });

    updateProgress();
  </script>
</body>
</html>
